# Copyright (C) 2021-2023 Technology Matters
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see https://www.gnu.org/licenses/.


name: Generate AI Training Set Task

on:
  push:
    branches:
      - "CHI-3008-link-summary"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment (development, staging, production)'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      helpline-shortcode:
        description: 'Helpline shortcode (lowercase)'
        required: true
        default: 'as'
        type: string

jobs:
  generate-ai-training-set:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: 'us-east-1'
      
      - name: Run New ECS task
        id: run-task
        run: |
          CLUSTER="development-ecs-cluster"
          FAMILY="development-hrm-scheduled-task"
          VPC="development-vpc"
          SECURITY_GROUPS=(
            "default"
            "development-rds-src-sg"
            "development-scheduled-task-sg"
            "development-ecs-tasks-sg")
          ENV_FILE="development.env"
          COMMAND="npm,run,start:generate-ai-training-set,development,${{ github.event.inputs.shortcode }},tl-aselo-ai-development"

          aws ecs run-task \
            --cluster $CLUSTER \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$VPC],securityGroups=[$(IFS=,; echo "${SECURITY_GROUPS[*]}")],assignPublicIp=DISABLED}" \
            --task-definition $FAMILY \
            --overrides '{
              "containerOverrides": [{
                "name": $FAMILY,
                "command": ["'$COMMAND'"],
                "environment": [{"name": "AWS_REGION", "value": "us-east-1"}]
              }],"taskRoleArn": $TASK_ROLE,
              "executionRoleArn": $EXEC_ROLE
            }'